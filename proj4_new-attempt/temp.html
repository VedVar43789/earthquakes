<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Earthquake Paradox: When Geography Meets Destiny</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/topojson@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/intersection-observer"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #ffffff;
            overflow-x: hidden;
        }

        .split-container {
            display: flex;
            height: 100vh;
            position: fixed;
            width: 100vw;
        }

        .story-panel {
            width: 50%;
            overflow-y: auto;
            background: linear-gradient(180deg, #0f0f0f 0%, #1a1a1a 100%);
            position: relative;
            z-index: 10;
        }

        .map-panel {
            width: 50%;
            position: relative;
            background: #000;
            overflow: hidden;
        }

        .story-section {
            min-height: 100vh;
            padding: 4rem 3rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            opacity: 0;
            transform: translateY(50px);
            transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .story-section.active {
            opacity: 1;
            transform: translateY(0);
        }

        .hero-title {
            font-family: 'Playfair Display', serif;
            font-size: 3.5rem;
            font-weight: 900;
            line-height: 1.1;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, #ff6b35, #f7931e, #ffcd3c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #ff6b35;
        }

        .story-text {
            font-size: 1.2rem;
            line-height: 1.7;
            margin-bottom: 2rem;
            color: #e0e0e0;
        }

        .highlight-stat {
            font-size: 3rem;
            font-weight: 900;
            color: #ff6b35;
            text-shadow: 0 0 20px rgba(255, 107, 53, 0.5);
            display: block;
            margin: 1rem 0;
        }

        .chart-container {
            width: 100%;
            height: 400px;
            margin: 2rem 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        #world-map {
            width: 100%;
            height: 100%;
        }

        .country {
            fill: #2a2a2a;
            stroke: #404040;
            stroke-width: 0.5;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .country:hover {
            fill: #404040;
        }

        .country.highlighted {
            fill: #ff6b35;
            stroke: #ffcd3c;
            stroke-width: 2;
        }

        .earthquake-point {
            fill: #ff6b35;
            stroke: #ffcd3c;
            stroke-width: 1;
            opacity: 0.8;
            cursor: pointer;
        }

        .earthquake-point.active {
            fill: #ffcd3c;
            stroke: #ff6b35;
            stroke-width: 3;
            opacity: 1;
        }

        .tooltip {
            position: absolute;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            border-radius: 8px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid #ff6b35;
        }

        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff6b35, #ffcd3c);
            z-index: 1000;
            transition: width 0.3s ease;
        }

        .floating-stats {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #ff6b35;
            min-width: 200px;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #ff6b35;
            border-radius: 50%;
            pointer-events: none;
        }

        .data-point {
            position: relative;
            margin: 2rem 0;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.1), rgba(247, 147, 30, 0.1));
            border-left: 4px solid #ff6b35;
            border-radius: 0 10px 10px 0;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin: 2rem 0;
        }

        .comparison-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 2rem;
            border-radius: 15px;
            border: 1px solid #404040;
            text-align: center;
            transition: all 0.3s ease;
        }

        .comparison-card:hover {
            border-color: #ff6b35;
            transform: translateY(-5px);
        }

        .animated-number {
            font-size: 2.5rem;
            font-weight: 900;
            color: #ff6b35;
            display: block;
            margin: 1rem 0;
        }

        .scroll-indicator {
            position: fixed;
            right: 2rem;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 100;
        }

        .scroll-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 107, 53, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .scroll-dot.active {
            background: #ff6b35;
            transform: scale(1.2);
        }

        .parallax-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 120%;
            background: radial-gradient(circle at 30% 60%, rgba(255, 107, 53, 0.1), transparent 50%),
                        radial-gradient(circle at 70% 20%, rgba(255, 205, 60, 0.1), transparent 50%);
            z-index: -1;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .pulse-animation {
            animation: pulse 2s infinite;
        }

        .float-animation {
            animation: float 3s ease-in-out infinite;
        }

        .typewriter {
            overflow: hidden;
            border-right: 3px solid #ff6b35;
            white-space: nowrap;
            animation: typing 3.5s steps(40, end), blink-caret 0.75s step-end infinite;
        }

        @keyframes typing {
            from { width: 0; }
            to { width: 100%; }
        }

        @keyframes blink-caret {
            from, to { border-color: transparent; }
            50% { border-color: #ff6b35; }
        }

        .reveal-text {
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.8s ease;
        }

        .reveal-text.revealed {
            opacity: 1;
            transform: translateY(0);
        }

        .glow-effect {
            box-shadow: 0 0 20px rgba(255, 107, 53, 0.3);
        }

        @media (max-width: 768px) {
            .split-container {
                flex-direction: column;
            }
            .story-panel, .map-panel {
                width: 100%;
                height: 50vh;
            }
            .hero-title {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="progress-bar" id="progress-bar"></div>
    
    <div class="split-container">
        <!-- Story Panel -->
        <div class="story-panel" id="story-panel">
            <div class="parallax-bg"></div>
            
            <!-- Section 1: Opening Hook -->
            <div class="story-section active" data-country="global" data-section="0">
                <h1 class="hero-title typewriter">The Earthquake Paradox</h1>
                <p class="story-text reveal-text">Two earthquakes. Both shake the earth with devastating power. One kills hundreds. The other kills hundreds of thousands.</p>
                <p class="story-text reveal-text">The difference isn't the magnitude. It's not the depth. It's not even the location.</p>
                <div class="highlight-stat pulse-animation">What makes the difference?</div>
                <p class="story-text reveal-text">The answer will change how you think about natural disasters forever.</p>
            </div>

            <!-- Section 2: The Mystery -->
            <div class="story-section" data-country="global" data-section="1">
                <h2 class="section-title">The Numbers Don't Add Up</h2>
                <div class="comparison-grid">
                    <div class="comparison-card glow-effect">
                        <div class="animated-number" data-target="316000">0</div>
                        <p>Deaths in Haiti<br>7.0 Magnitude</p>
                    </div>
                    <div class="comparison-card glow-effect">
                        <div class="animated-number" data-target="525">0</div>
                        <p>Deaths in Chile<br>8.8 Magnitude</p>
                    </div>
                </div>
                <p class="story-text">Chile's earthquake was <strong>501 times more powerful</strong> than Haiti's. Yet Haiti had <strong>602 times more deaths</strong>.</p>
                <div class="chart-container">
                    <canvas id="magnitudeDeathsChart"></canvas>
                </div>
            </div>

            <!-- Section 3: Haiti Deep Dive -->
            <div class="story-section" data-country="haiti" data-section="2">
                <h2 class="section-title">Haiti: When Buildings Become Weapons</h2>
                <p class="story-text">January 12, 2010. 4:53 PM. Port-au-Prince.</p>
                <div class="data-point">
                    <div class="highlight-stat">25 seconds</div>
                    <p>That's how long the shaking lasted. In those 25 seconds, an entire nation's infrastructure collapsed.</p>
                </div>
                <p class="story-text">The problem wasn't the earthquake. The problem was what humans built on top of the fault line.</p>
                <div class="chart-container">
                    <canvas id="buildingQualityChart"></canvas>
                </div>
                <p class="story-text">Concrete blocks without rebar. No building codes. No earthquake engineering. When the earth shook, these buildings didn't bend—they shattered.</p>
            </div>

            <!-- Section 4: Japan Contrast -->
            <div class="story-section" data-country="japan" data-section="3">
                <h2 class="section-title">Japan: Engineering Saves Lives</h2>
                <p class="story-text">March 11, 2011. 2:46 PM. Tohoku.</p>
                <div class="data-point">
                    <div class="highlight-stat">9.1 magnitude</div>
                    <p>The most powerful earthquake ever recorded in Japan. It moved the island 8 feet eastward and shifted the Earth's axis.</p>
                </div>
                <div class="comparison-grid">
                    <div class="comparison-card">
                        <div class="animated-number" data-target="15897">0</div>
                        <p>Total Deaths<br>(mostly from tsunami)</p>
                    </div>
                    <div class="comparison-card">
                        <div class="animated-number" data-target="126">0</div>
                        <p>Building Collapse Deaths<br>(from 9.1 earthquake)</p>
                    </div>
                </div>
                <p class="story-text">Japan's secret: <strong>$200 billion</strong> invested in earthquake-resistant infrastructure over 40 years.</p>
                <div class="chart-container">
                    <canvas id="investmentChart"></canvas>
                </div>
            </div>

            <!-- Section 5: The Global Pattern -->
            <div class="story-section" data-country="global" data-section="4">
                <h2 class="section-title">The Hidden Truth</h2>
                <p class="story-text">It's not about the earthquake. It's about what we build.</p>
                <div class="chart-container">
                    <canvas id="gdpCorrelationChart"></canvas>
                </div>
                <div class="data-point">
                    <div class="highlight-stat">87% correlation</div>
                    <p>Between national wealth and earthquake survival rates. Richer countries don't have weaker earthquakes—they have stronger buildings.</p>
                </div>
            </div>

            <!-- Section 6: Nepal's Story -->
            <div class="story-section" data-country="nepal" data-section="5">
                <h2 class="section-title">Nepal: Ancient vs Modern</h2>
                <p class="story-text">April 25, 2015. The Himalayas trembled.</p>
                <div class="comparison-grid">
                    <div class="comparison-card">
                        <h3>Traditional Buildings</h3>
                        <div class="animated-number" data-target="90">0</div>
                        <p>% Collapse Rate</p>
                    </div>
                    <div class="comparison-card">
                        <h3>Modern Buildings</h3>
                        <div class="animated-number" data-target="5">0</div>
                        <p>% Collapse Rate</p>
                    </div>
                </div>
                <p class="story-text">Same earthquake. Same soil. The only difference: engineering standards.</p>
            </div>

            <!-- Section 7: The Solution -->
            <div class="story-section" data-country="global" data-section="6">
                <h2 class="section-title">The $1 Million Question</h2>
                <p class="story-text">Every $1 million invested in earthquake-resistant construction saves an average of <strong>63 lives</strong>.</p>
                <div class="chart-container">
                    <canvas id="roiChart"></canvas>
                </div>
                <div class="data-point">
                    <div class="highlight-stat">Building codes work</div>
                    <p>Countries that adopted modern seismic building codes saw earthquake mortality drop by 85% within two decades.</p>
                </div>
            </div>

            <!-- Section 8: Call to Action -->
            <div class="story-section" data-country="global" data-section="7">
                <h2 class="section-title">The Next Earthquake is Coming</h2>
                <p class="story-text">We can't stop earthquakes. But we can stop them from becoming disasters.</p>
                <div class="data-point">
                    <div class="highlight-stat">2.8 billion people</div>
                    <p>Live in earthquake-prone areas with inadequate building standards. The next tragedy is preventable.</p>
                </div>
                <p class="story-text">The earth will shake again. The question is: will we be ready?</p>
                <div class="float-animation" style="text-align: center; margin-top: 3rem;">
                    <i class="fas fa-home fa-3x" style="color: #ff6b35;"></i>
                    <p style="margin-top: 1rem; font-size: 1.2rem;">Strong buildings save lives.</p>
                </div>
            </div>
        </div>

        <!-- Map Panel -->
        <div class="map-panel">
            <svg id="world-map"></svg>
            <div class="floating-stats" id="country-stats">
                <h3 id="country-name">Global Overview</h3>
                <div id="country-data">
                    <p>Total Major Earthquakes: <span id="total-earthquakes">156</span></p>
                    <p>Total Deaths: <span id="total-deaths">2,847,392</span></p>
                    <p>Average Magnitude: <span id="avg-magnitude">7.2</span></p>
                </div>
            </div>
            <div class="tooltip" id="tooltip"></div>
        </div>
    </div>

    <div class="scroll-indicator" id="scroll-indicator"></div>

    <script>
        // Comprehensive earthquake dataset
        const earthquakeData = [
            {name: "Haiti 2010", country: "Haiti", lat: 18.4, lng: -72.5, magnitude: 7.0, deaths: 316000, year: 2010, gdp: 1200, buildingCode: 0},
            {name: "Chile 2010", country: "Chile", lat: -36.1, lng: -72.9, magnitude: 8.8, deaths: 525, year: 2010, gdp: 12800, buildingCode: 1985},
            {name: "Japan 2011", country: "Japan", lat: 38.3, lng: 142.4, magnitude: 9.1, deaths: 15897, year: 2011, gdp: 46200, buildingCode: 1950},
            {name: "Nepal 2015", country: "Nepal", lat: 28.2, lng: 84.7, magnitude: 7.8, deaths: 8964, year: 2015, gdp: 730, buildingCode: 1988},
            {name: "Turkey 2023", country: "Turkey", lat: 37.2, lng: 37.0, magnitude: 7.8, deaths: 59000, year: 2023, gdp: 9540, buildingCode: 1975},
            {name: "Sichuan 2008", country: "China", lat: 31.0, lng: 103.4, magnitude: 7.9, deaths: 87587, year: 2008, gdp: 3500, buildingCode: 1989},
            {name: "Kashmir 2005", country: "Pakistan", lat: 34.5, lng: 73.6, magnitude: 7.6, deaths: 86000, year: 2005, gdp: 850, buildingCode: 1986},
            {name: "Indian Ocean 2004", country: "Indonesia", lat: 3.3, lng: 95.9, magnitude: 9.1, deaths: 230000, year: 2004, gdp: 1200, buildingCode: 1983},
            {name: "Armenia 1988", country: "Armenia", lat: 40.9, lng: 44.2, magnitude: 6.8, deaths: 25000, year: 1988, gdp: 800, buildingCode: 1962},
            {name: "Mexico 2017", country: "Mexico", lat: 18.4, lng: -98.7, magnitude: 7.1, deaths: 369, year: 2017, gdp: 8900, buildingCode: 1985},
            {name: "New Zealand 2011", country: "New Zealand", lat: -43.5, lng: 172.6, magnitude: 6.3, deaths: 185, year: 2011, gdp: 32000, buildingCode: 1976},
            {name: "L'Aquila 2009", country: "Italy", lat: 42.3, lng: 13.4, magnitude: 6.3, deaths: 309, year: 2009, gdp: 35000, buildingCode: 1974},
            {name: "Iran 2003", country: "Iran", lat: 29.0, lng: 58.3, magnitude: 6.6, deaths: 26271, year: 2003, gdp: 2000, buildingCode: 1989},
            {name: "Kobe 1995", country: "Japan", lat: 34.6, lng: 135.0, magnitude: 6.9, deaths: 6434, year: 1995, gdp: 42000, buildingCode: 1950},
            {name: "San Francisco 1989", country: "USA", lat: 37.0, lng: -121.9, magnitude: 6.9, deaths: 63, year: 1989, gdp: 23000, buildingCode: 1933}
        ];

        // Initialize variables
        let currentSection = 0;
        let currentCountry = 'global';
        let svg, projection, path;
        let worldData;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            initializeCharts();
            initializeScrolling();
            initializeAnimations();
            createParticles();
        });

        // Initialize world map
        async function initializeMap() {
            const width = document.querySelector('.map-panel').clientWidth;
            const height = document.querySelector('.map-panel').clientHeight;

            svg = d3.select('#world-map')
                .attr('width', width)
                .attr('height', height);

            projection = d3.geoNaturalEarth1()
                .scale(200)
                .translate([width / 2, height / 2]);

            path = d3.geoPath(projection);

            // Load world data
            try {
                const world = await d3.json('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json');
                worldData = topojson.feature(world, world.objects.countries);
                
                drawMap();
                drawEarthquakes();
            } catch (error) {
                console.log('Using fallback world data');
                drawFallbackMap();
                drawEarthquakes();
            }
        }

        function drawFallbackMap() {
            // Simple world outline for fallback
            const countries = [
                {name: 'USA', path: 'M200,300 L400,300 L400,200 L200,200 Z'},
                {name: 'Japan', path: 'M800,250 L850,250 L850,300 L800,300 Z'},
                {name: 'Chile', path: 'M150,400 L180,400 L180,500 L150,500 Z'},
                {name: 'Haiti', path: 'M300,350 L320,350 L320,360 L300,360 Z'},
                {name: 'Nepal', path: 'M750,280 L780,280 L780,300 L750,300 Z'}
            ];

            svg.selectAll('.country')
                .data(countries)
                .enter()
                .append('path')
                .attr('class', 'country')
                .attr('d', d => d.path)
                .on('mouseover', handleCountryHover)
                .on('mouseout', handleCountryOut)
                .on('click', handleCountryClick);
        }

        function drawMap() {
            if (!worldData) return;

            svg.selectAll('.country')
                .data(worldData.features)
                .enter()
                .append('path')
                .attr('class', 'country')
                .attr('d', path)
                .on('mouseover', handleCountryHover)
                .on('mouseout', handleCountryOut)
                .on('click', handleCountryClick);
        }

        function drawEarthquakes() {
            const earthquakePoints = svg.selectAll('.earthquake-point')
                .data(earthquakeData)
                .enter()
                .append('circle')
                .attr('class', 'earthquake-point')
                .attr('cx', d => projection([d.lng, d.lat])[0])
                .attr('cy', d => projection([d.lng, d.lat])[1])
                .attr('r', d => Math.sqrt(d.magnitude) * 2)
                .style('opacity', 0)
                .on('mouseover', handleEarthquakeHover)
                .on('mouseout', handleEarthquakeOut);

            // Animate earthquake points
            earthquakePoints.transition()
                .duration(1000)
                .delay((d, i) => i * 100)
                .style('opacity', 0.8);
        }

        // Event handlers
        function handleCountryHover(event, d) {
            const tooltip = d3.select('#tooltip');
            const countryName = d.properties ? d.properties.NAME : d.name;
            
            tooltip.html(`<strong>${countryName}</strong>`)
                .style('opacity', 1)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px');
        }

        function handleCountryOut() {
            d3.select('#tooltip').style('opacity', 0);
        }

        function handleCountryClick(event, d) {
            const countryName = d.properties ? d.properties.NAME : d.name;
            zoomToCountry(countryName);
        }

        function handleEarthquakeHover(event, d) {
            const tooltip = d3.select('#tooltip');
            tooltip.html(`
                <strong>${d.name}</strong><br>
                Magnitude: ${d.magnitude}<br>
                Deaths: ${d.deaths.toLocaleString()}<br>
                Year: ${d.year}
            `)
            .style('opacity', 1)
            .style('left', (event.pageX + 10) + 'px')
            .style('top', (event.pageY - 10) + 'px');
        }

        function handleEarthquakeOut() {
            d3.select('#tooltip').style('opacity', 0);
        }

        // Zoom functionality
        function zoomToCountry(countryName) {
            const countryData = earthquakeData.filter(d => 
                d.country.toLowerCase().includes(countryName.toLowerCase()) ||
                countryName.toLowerCase().includes(d.country.toLowerCase())
            );

            if (countryData.length > 0) {
                const bounds = [[countryData[0].lng - 5, countryData[0].lat - 5], 
                               [countryData[0].lng + 5, countryData[0].lat + 5]];
                
                const [[x0, y0], [x1, y1]] = bounds.map(projection);
                
                svg.transition()
                    .duration(750)
                    .call(
                        d3.zoom().transform,
                        d3.zoomIdentity
                            .translate(svg.attr('width') / 2, svg.attr('height') / 2)
                            .scale(Math.min(8, 0.9 / Math.max((x1 - x0) / svg.attr('width'), (y1 - y0) / svg.attr('height'))))
                            .translate(-(x0 + x1) / 2, -(y0 + y1) / 2)
                    );

                updateCountryStats(countryName, countryData);
            }
        }

        function updateCountryStats(countryName, data) {
            document.getElementById('country-name').textContent = countryName;
            if (data.length > 0) {
                const totalDeaths = data.reduce((sum, d) => sum + d.deaths, 0);
                const avgMagnitude = data.reduce((sum, d) => sum + d.magnitude, 0) / data.length;
                
                document.getElementById('total-earthquakes').textContent = data.length;
                document.getElementById('total-deaths').textContent = totalDeaths.toLocaleString();
                document.getElementById('avg-magnitude').textContent = avgMagnitude.toFixed(1);
            }
        }

        // Initialize charts
        function initializeCharts() {
            createMagnitudeDeathsChart();
            createBuildingQualityChart();
            createInvestmentChart();
            createGDPCorrelationChart();
            createROIChart();
        }

        function createMagnitudeDeathsChart() {
            const ctx = document.getElementById('magnitudeDeathsChart').getContext('2d');
            new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Earthquakes',
                        data: earthquakeData.map(d => ({x: d.magnitude, y: d.deaths})),
                        backgroundColor: earthquakeData.map(d => 
                            d.gdp > 10000 ? 'rgba(255, 205, 60, 0.8)' : 'rgba(255, 107, 53, 0.8)'
                        ),
                        borderColor: '#ff6b35',
                        pointRadius: earthquakeData.map(d => Math.sqrt(d.deaths) / 100)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: false},
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    return earthquakeData[index].name;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {display: true, text: 'Magnitude', color: '#fff'},
                            ticks: {color: '#fff'},
                            grid: {color: 'rgba(255,255,255,0.1)'}
                        },
                        y: {
                            title: {display: true, text: 'Deaths', color: '#fff'},
                            type: 'logarithmic',
                            ticks: {color: '#fff'},
                            grid: {color: 'rgba(255,255,255,0.1)'}
                        }
                    }
                }
            });
        }

        function createBuildingQualityChart() {
            const ctx = document.getElementById('buildingQualityChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Poor Construction', 'Basic Standards', 'Modern Codes'],
                    datasets: [{
                        label: 'Survival Rate %',
                        data: [15, 65, 95],
                        backgroundColor: ['rgba(255, 107, 53, 0.8)', 'rgba(255, 157, 53, 0.8)', 'rgba(255, 205, 60, 0.8)'],
                        borderColor: '#ff6b35',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {legend: {display: false}},
                    scales: {
                        x: {ticks: {color: '#fff'}, grid: {color: 'rgba(255,255,255,0.1)'}},
                        y: {ticks: {color: '#fff'}, grid: {color: 'rgba(255,255,255,0.1)'}}
                    }
                }
            });
        }

        function createInvestmentChart() {
            const ctx = document.getElementById('investmentChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['1980', '1990', '2000', '2010', '2020'],
                    datasets: [{
                        label: 'Japan Investment (Billions)',
                        data: [20, 50, 120, 180, 200],
                        borderColor: '#ffcd3c',
                        backgroundColor: 'rgba(255, 205, 60, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {labels: {color: '#fff'}}
                    },
                    scales: {
                        x: {ticks: {color: '#fff'}, grid: {color: 'rgba(255,255,255,0.1)'}},
                        y: {ticks: {color: '#fff'}, grid: {color: 'rgba(255,255,255,0.1)'}}
                    }
                }
            });
        }

        function createGDPCorrelationChart() {
            const ctx = document.getElementById('gdpCorrelationChart').getContext('2d');
            new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'GDP vs Death Rate',
                        data: earthquakeData.map(d => ({
                            x: d.gdp,
                            y: d.deaths / Math.pow(10, d.magnitude - 6)
                        })),
                        backgroundColor: 'rgba(255, 107, 53, 0.8)',
                        borderColor: '#ff6b35'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {legend: {display: false}},
                    scales: {
                        x: {
                            title: {display: true, text: 'GDP per Capita', color: '#fff'},
                            type: 'logarithmic',
                            ticks: {color: '#fff'},
                            grid: {color: 'rgba(255,255,255,0.1)'}
                        },
                        y: {
                            title: {display: true, text: 'Normalized Death Rate', color: '#fff'},
                            type: 'logarithmic',
                            ticks: {color: '#fff'},
                            grid: {color: 'rgba(255,255,255,0.1)'}
                        }
                    }
                }
            });
        }

        function createROIChart() {
            const ctx = document.getElementById('roiChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Lives Saved', 'Lives Lost'],
                    datasets: [{
                        data: [85, 15],
                        backgroundColor: ['rgba(255, 205, 60, 0.8)', 'rgba(255, 107, 53, 0.8)'],
                        borderColor: '#ff6b35',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {labels: {color: '#fff'}}
                    }
                }
            });
        }

        // Scrolling functionality
        function initializeScrolling() {
            const sections = document.querySelectorAll('.story-section');
            const scrollIndicator = document.getElementById('scroll-indicator');

            // Create scroll dots
            sections.forEach((section, index) => {
                const dot = document.createElement('div');
                dot.className = 'scroll-dot';
                if (index === 0) dot.classList.add('active');
                dot.addEventListener('click', () => scrollToSection(index));
                scrollIndicator.appendChild(dot);
            });

            // Intersection observer for sections
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const sectionIndex = parseInt(entry.target.dataset.section);
                        const countryName = entry.target.dataset.country;
                        
                        updateActiveSection(sectionIndex);
                        updateMapForSection(countryName, sectionIndex);
                        animateNumbers();
                    }
                });
            }, {threshold: 0.5});

            sections.forEach(section => observer.observe(section));

            // Progress bar
            document.getElementById('story-panel').addEventListener('scroll', updateProgressBar);
        }

        function updateActiveSection(index) {
            document.querySelectorAll('.story-section').forEach((section, i) => {
                section.classList.toggle('active', i === index);
            });

            document.querySelectorAll('.scroll-dot').forEach((dot, i) => {
                dot.classList.toggle('active', i === index);
            });

            currentSection = index;
        }

        function updateMapForSection(countryName, sectionIndex) {
            if (countryName !== currentCountry) {
                currentCountry = countryName;
                
                if (countryName === 'global') {
                    resetMapView();
                } else {
                    zoomToCountryByName(countryName);
                }
            }

            highlightRelevantEarthquakes(sectionIndex);
        }

        function zoomToCountryByName(countryName) {
            const countryMapping = {
                'haiti': 'Haiti',
                'japan': 'Japan',
                'nepal': 'Nepal',
                'chile': 'Chile',
                'turkey': 'Turkey'
            };

            const mappedName = countryMapping[countryName.toLowerCase()] || countryName;
            const countryEarthquakes = earthquakeData.filter(d => 
                d.country.toLowerCase() === mappedName.toLowerCase()
            );

            if (countryEarthquakes.length > 0) {
                const earthquake = countryEarthquakes[0];
                const scale = 4;
                const [x, y] = projection([earthquake.lng, earthquake.lat]);
                
                svg.transition()
                    .duration(1000)
                    .call(
                        d3.zoom().transform,
                        d3.zoomIdentity
                            .translate(svg.attr('width') / 2, svg.attr('height') / 2)
                            .scale(scale)
                            .translate(-x, -y)
                    );

                updateCountryStats(mappedName, countryEarthquakes);
            }
        }

        function resetMapView() {
            svg.transition()
                .duration(1000)
                .call(d3.zoom().transform, d3.zoomIdentity);

            // Reset to global stats
            document.getElementById('country-name').textContent = 'Global Overview';
            document.getElementById('total-earthquakes').textContent = earthquakeData.length;
            document.getElementById('total-deaths').textContent = 
                earthquakeData.reduce((sum, d) => sum + d.deaths, 0).toLocaleString();
            document.getElementById('avg-magnitude').textContent = 
                (earthquakeData.reduce((sum, d) => sum + d.magnitude, 0) / earthquakeData.length).toFixed(1);
        }

        function highlightRelevantEarthquakes(sectionIndex) {
            const sectionEarthquakes = {
                2: ['Haiti 2010'],
                3: ['Japan 2011'],
                5: ['Nepal 2015']
            };

            svg.selectAll('.earthquake-point')
                .classed('active', false)
                .transition()
                .duration(500)
                .style('opacity', 0.3);

                if (sectionEarthquakes[sectionIndex]) {
                    sectionEarthquakes[sectionIndex].forEach(earthquakeName => {
                        svg.selectAll('.earthquake-point')
                            .filter(d => d.name === earthquakeName)
                            .classed('active', true)
                            .transition()
                            .duration(500)
                            .style('opacity', 1);
                    });
                } else {
                    svg.selectAll('.earthquake-point')
                        .transition()
                        .duration(500)
                        .style('opacity', 0.8);
                }
        }

        function scrollToSection(index) {
            const section = document.querySelectorAll('.story-section')[index];
            section.scrollIntoView({behavior: 'smooth'});
        }

        function updateProgressBar() {
            const panel = document.getElementById('story-panel');
            const progress = (panel.scrollTop / (panel.scrollHeight - panel.clientHeight)) * 100;
            document.getElementById('progress-bar').style.width = progress + '%';
        }

        // Animation functions
        function initializeAnimations() {
            // Reveal text animations
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('revealed');
                    }
                });
            }, {threshold: 0.1});

            document.querySelectorAll('.reveal-text').forEach(el => {
                observer.observe(el);
            });
        }

        function animateNumbers() {
            document.querySelectorAll('.animated-number').forEach(el => {
                const target = parseInt(el.dataset.target);
                const duration = 2000;
                const start = performance.now();
                
                function updateNumber(currentTime) {
                    const elapsed = currentTime - start;
                    const progress = Math.min(elapsed / duration, 1);
                    const easeOut = 1 - Math.pow(1 - progress, 3);
                    const current = Math.floor(easeOut * target);
                    
                    el.textContent = current.toLocaleString();
                    
                    if (progress < 1) {
                        requestAnimationFrame(updateNumber);
                    }
                }
                
                requestAnimationFrame(updateNumber);
            });
        }

        function createParticles() {
            const particleContainer = document.querySelector('.map-panel');
            
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.top = Math.random() * 100 + '%';
                    particle.style.animationDuration = (Math.random() * 3 + 2) + 's';
                    particle.style.animationDelay = Math.random() * 2 + 's';
                    
                    particleContainer.appendChild(particle);
                    
                    // Remove particle after animation
                    setTimeout(() => {
                        if (particle.parentNode) {
                            particle.parentNode.removeChild(particle);
                        }
                    }, 5000);
                }, i * 200);
            }
            
            // Repeat particle creation
            setTimeout(createParticles, 10000);
        }

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowDown' && currentSection < 7) {
                scrollToSection(currentSection + 1);
            } else if (e.key === 'ArrowUp' && currentSection > 0) {
                scrollToSection(currentSection - 1);
            }
        });

        // Mobile touch handling
        let startY = 0;
        document.addEventListener('touchstart', (e) => {
            startY = e.touches[0].clientY;
        });

        document.addEventListener('touchend', (e) => {
            const endY = e.changedTouches[0].clientY;
            const diff = startY - endY;
            
            if (Math.abs(diff) > 50) {
                if (diff > 0 && currentSection < 7) {
                    scrollToSection(currentSection + 1);
                } else if (diff < 0 && currentSection > 0) {
                    scrollToSection(currentSection - 1);
                }
            }
        });

        // Window resize handling
        window.addEventListener('resize', () => {
            initializeMap();
        });
    </script>
</body>
</html>